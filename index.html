<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RUN EBE RUN</title>
<style>
  :root{
    --bg-0:#f5f7fb;
    --ink:#1f2a44;
    --mint:#86e3ce;
    --peach:#ffd3b6;
    --lilac:#d4b5ff;
    --sky:#a8d8ff;
    --rose:#ffb3c1;
    --shadow: 0 10px 30px rgba(31,42,68,.18);
    --stroke: rgba(31,42,68,.08);
  }
  html,body{margin:0;height:100%;background:var(--bg-0);color:var(--ink);
    font-family: ui-rounded, system-ui, "Segoe UI", Roboto, Arial, sans-serif;}
  #gameWrap{position:relative;width:100%;height:100vh;overflow:hidden}

  canvas{
    display:block;margin:0 auto;border-radius:18px;
    box-shadow:var(--shadow); background:#ffffff;
  }

  /* Glass panels */
  #titleScreen,#leaderboardPanel,#gameOverPanel{
    position:absolute; inset:0; display:flex; flex-direction:column; gap:12px;
    align-items:center; justify-content:center; text-align:center;
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.25));
    padding:20px; color:var(--ink);
  }
  #leaderboardPanel,#gameOverPanel{ display:none; }
  #titleScreen h1{font-size:42px; letter-spacing:.5px; margin:0 0 6px}
  #titleScreen p{opacity:.9; margin:0 0 6px}

  input,button{
    padding:12px 16px; border:1px solid var(--stroke);
    border-radius:14px; font-weight:600; background:#fff;
  }
  input{ min-width:240px; }
  button{ cursor:pointer; transition:.2s box-shadow,.2s transform }
  button:hover{ box-shadow:var(--shadow); transform: translateY(-1px) }
  #btnStart{ background: linear-gradient(90deg,var(--mint),var(--sky)); border:0; color:#103; }
  #btnShowLeaderboard{ background: linear-gradient(90deg,var(--peach),var(--rose)); border:0; color:#103; }
  #btnExportCSV{ background:linear-gradient(90deg,#fff,var(--mint)); }

  table{background:#fff; border-radius:14px; overflow:hidden; box-shadow:var(--shadow)}
  td,th{padding:10px 14px; border-bottom:1px solid var(--stroke)}
  th{background:#f7f9ff}

  /* Mobile pad */
  #mobilePad{
    position:absolute; left:0; right:0; bottom:14px;
    display:none; gap:10px; justify-content:center
  }
  .pad{ padding:14px 16px; border-radius:16px; background:#fff; border:1px solid var(--stroke) }
  @media (pointer:coarse){ #mobilePad{ display:flex } }
</style>
</head>
<body>
<div id="gameWrap">
  <canvas id="game" width="1280" height="720"></canvas>

  <!-- START -->
  <div id="titleScreen">
    <h1>RUN EBE RUN</h1>
    <p style="max-width:660px">
      Sprint through a bright hospital corridor, collect <b>Care Coins</b>, and keep the rhythm of birth!<br>
      Watch out for <b>Slippery Spills</b>, <b>Panic Puffs</b>, and towering <b>Paperwork Piles</b> — stay calm, stay caring, keep moving!
    </p>
    <label for="playerName">Player Name</label>
    <input id="playerName" maxlength="12" placeholder="Runebe"/>
    <div>
      <button id="btnStart">Start</button>
      <button id="btnShowLeaderboard">Leaderboard</button>
    </div>
    <small style="opacity:.75">
      Desktop: ← → move · Space jump (×2) · S slide · D dash · P pause · L slow-mode
    </small>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboardPanel">
    <h2>Leaderboard (Top 10)</h2>
    <table id="lbTable"><thead><tr><th>#</th><th>Name</th><th>Score</th><th>Date</th></tr></thead><tbody></tbody></table>
    <div>
      <button id="btnExportCSV">Export CSV</button>
      <button id="btnCloseLB">Close</button>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="gameOverPanel">
    <h2>Game Over</h2>
    <p id="finalScoreText">Score: 0</p>
    <div>
      <button id="btnRestart">Restart</button>
      <button id="btnGoTitle">Title</button>
    </div>
  </div>

  <!-- Mobile pad -->
  <div id="mobilePad">
    <button class="pad" id="btnLeft">◀</button>
    <button class="pad" id="btnRight">▶</button>
    <button class="pad" id="btnJump">⤒</button>
    <button class="pad" id="btnSlide">—</button>
    <button class="pad" id="btnDash">⚡</button>
  </div>
</div>

<script>
/* ========= tiny utils ========= */
const $=s=>document.querySelector(s);
const W=1280,H=720;
const LS_NAME='rer_name', LS_LB='rer_leaderboard_v1';

/* ========= leaderboard (name+score + CSV) ========= */
const LB = (()=> {
  const tBody = document.createElement('tbody'); // will be replaced on DOMContentLoaded if table exists
  const saveName = () => {
    const inp = document.getElementById('playerName');
    const n = (inp?.value||'Runebe').trim().slice(0,12);
    localStorage.setItem(LS_NAME,n); return n;
  };
  const getName = () => (localStorage.getItem(LS_NAME) || document.getElementById('playerName')?.value || 'Runebe').trim().slice(0,12);
  const load = ()=>JSON.parse(localStorage.getItem(LS_LB)||'[]');
  const store = arr=>localStorage.setItem(LS_LB,JSON.stringify(arr));
  const add = (score)=>{
    const arr=load(); arr.push({name:saveName(),score,at:new Date().toISOString()});
    arr.sort((a,b)=>b.score-a.score || a.at.localeCompare(b.at));
    store(arr.slice(0,10)); render();
  };
  const render = ()=>{
    const tableBody = document.querySelector('#lbTable tbody') || tBody;
    const arr=load(); tableBody.innerHTML='';
    arr.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.score}</td><td>${new Date(r.at).toLocaleDateString()}</td>`;
      tableBody.appendChild(tr);
    });
  };
  const exportCSV=()=>{
    const arr=load(); const head='rank,name,score,date\n';
    const lines=arr.map((r,i)=>`${i+1},"${r.name.replace(/"/g,'""')}",${r.score},${r.at}`);
    const blob=new Blob([head+lines.join('\n')],{type:'text/csv'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='runebe_leaderboard.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  return {saveName,getName,add,render,exportCSV};
})();

/* ========= canvas & state ========= */
const canvas=$('#game'), ctx=canvas.getContext('2d');
let running=false, paused=false, slow=false;
let t=0, speed=6, vx=0, x=120, y=H-120, vy=0, onGround=true;
let hearts=3, score=0, coins=[], hazards=[], combo=0, corridorCoins=0;
let difficulty=0;

function resetRun(){
  speed=6; vx=0; x=120; y=H-120; vy=0; onGround=true;
  hearts=3; score=0; combo=0; coins=[]; hazards=[]; corridorCoins=0; difficulty=0;
}

/* ========= helpers ========= */
function roundedRect(ctx,x,y,w,h,r){
  const rr=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}
function drawCareCoin(c){
  const {x,y,r}=c;
  ctx.fillStyle='#ffd86b';
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#ffffff';
  const s=r*0.5;
  roundedRect(ctx,x-s,y-0.12*r,2*s,0.24*r,4); ctx.fill();
  roundedRect(ctx,x-0.12*r,y-s,0.24*r,2*s,4); ctx.fill();
}
function drawCorridorBackground(){
  const wallTop = '#ffffff', line = 'rgba(31,42,68,.08)';
  const midY = H*0.55;

  const gTop = ctx.createLinearGradient(0,0,0,midY);
  gTop.addColorStop(0,'#ffffff');
  gTop.addColorStop(1,'#f8fbff');
  ctx.fillStyle = gTop; ctx.fillRect(0,0,W,midY);

  const gFloor = ctx.createLinearGradient(0,midY,0,H);
  gFloor.addColorStop(0,'#eef3ff');
  gFloor.addColorStop(1,'#e3ecff');
  ctx.fillStyle = gFloor; ctx.fillRect(0,midY,W,H-midY);

  ctx.strokeStyle = line; ctx.lineWidth=1;
  const vanX = W/2, vanY = midY-80;
  for(let i=0;i<12;i++){
    const frac = (i/11 - 0.5)*2;
    ctx.beginPath();
    ctx.moveTo(vanX + frac*40, vanY);
    ctx.lineTo( (frac*0.5+0.5)*W, H );
    ctx.stroke();
  }
  for(let y=midY+20,step=18;y<H;y+=step,step*=1.08){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }

  const doorW=70, doorH=120;
  ctx.fillStyle='#ffffff';
  for(let i=0;i<4;i++){
    const offs=(i*280 + (t*80)%280);
    const xR=W-40 - offs; const y=midY-40;
    if(xR>-doorW && xR<W){
      roundedRect(ctx,xR,y,doorW,doorH,10); ctx.fill();
      ctx.fillStyle='rgba(31,42,68,.06)'; ctx.fillRect(xR+doorW-10,y+55,4,18);
      ctx.fillStyle='#ffffff';
    }
    const xL=40 + offs;
    if(xL>-doorW && xL<W){
      roundedRect(ctx,xL,y,doorW,doorH,10); ctx.fill();
      ctx.fillStyle='rgba(31,42,68,.06)'; ctx.fillRect(xL+6,y+55,4,18);
      ctx.fillStyle='#ffffff';
    }
  }

  for(let i=0;i<5;i++){
    const lx=((i*260 + (t*50)%260) % (W+160)) - 80;
    const ly= midY-120;
    ctx.fillStyle='rgba(255,255,255,.9)';
    roundedRect(ctx,lx,ly,60,14,7); ctx.fill();
    const glow=ctx.createRadialGradient(lx+30,ly+7,5,lx+30,ly+7,90);
    glow.addColorStop(0,'rgba(255,255,255,.35)');
    glow.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(lx+30,ly+7,90,0,Math.PI*2); ctx.fill();
  }
}

/* Spawners */
function spawnCoin(){
  const lanes=[0,60,120];
  coins.push({x:W+40,y:H-120-lanes[Math.floor(Math.random()*lanes.length)],r:12});
}
function spawnHazard(){
  const r = Math.random();
  const baseY = H-100;
  if (r < 0.4){
    hazards.push({type:'spill', x:W+60, y:baseY, w:60, h:26});
  } else if (r < 0.7){
    const yy = baseY - 60 - Math.random()*100;
    hazards.push({type:'panic', x:W+60, y:yy, vy:(Math.random()<.5?0.4:-0.4)});
  } else {
    hazards.push({type:'paper', x:W+60, y:baseY-40, w:40, h:40});
  }
}

/* Physics & difficulty */
function tick(dt){
  difficulty += dt * 0.06;
  speed = 6 + difficulty*1.2 + Math.min(2, Math.floor(score/200)*0.5);

  t += dt*(slow?0.5:1);

  if (t%1 < dt){
    const coinChance = 0.65 + Math.min(.2, difficulty*0.15);
    const hazardChance = 0.20 + Math.min(.45, difficulty*0.25);
    if (Math.random() < coinChance) spawnCoin();
    if (Math.random() < hazardChance) spawnHazard();
  }

  x += vx; vy += 0.9; y += vy;
  if (y>H-120){ y=H-120; vy=0; onGround=true; }

  coins.forEach(c=>c.x -= speed);
  hazards.forEach(h=>{
    h.x = (h.x ?? W) - speed;
    if(h.type==='panic'){
      h.y += h.vy;
      if (h.y < H-220 || h.y > H-80) h.vy *= -1;
    }
  });

  coins = coins.filter(c=>{
    const dx=(x+20)-c.x, dy=(y+20)-c.y;
    const hit = Math.hypot(dx,dy) < (20+c.r);
    if (hit){ score += 10*(1+Math.floor(combo/5)); combo++; corridorCoins++; }
    return !hit && c.x>-40;
  });

  hazards = hazards.filter(h=>{
    let hit=false;
    if (h.type==='panic'){
      hit = Math.hypot((x+20)-h.x,(y+20)-h.y) < 30;
    } else {
      hit = (x+20>h.x && x<h.x+(h.w||0) && y+40>h.y && y<h.y+(h.h||0));
    }
    if (hit){ hearts--; combo=0; }
    return !hit && h.x>-60;
  });

  if (corridorCoins >= 60){ corridorCoins=0; speed += 0.6; }
  if (hearts<=0) gameOver();
}

/* Drawing */
function draw(){
  drawCorridorBackground();

  ctx.fillStyle='#ffc9de';
  roundedRect(ctx,x,y,40,40,10); ctx.fill();

  coins.forEach(drawCareCoin);

  hazards.forEach(h=>{
    if(h.type==='spill'){
      ctx.fillStyle='#a8d8ff'; roundedRect(ctx,h.x,h.y,h.w,h.h,8); ctx.fill();
      ctx.globalAlpha=.25; ctx.fillStyle='#fff'; roundedRect(ctx,h.x+6,h.y+5,h.w-12,h.h-10,8); ctx.fill(); ctx.globalAlpha=1;
    }else if(h.type==='panic'){
      ctx.globalAlpha=.75; ctx.fillStyle='#ffd3b6';
      ctx.beginPath(); ctx.arc(h.x,h.y,22,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=1;
    }else{
      ctx.fillStyle='#d4b5ff';
      roundedRect(ctx,h.x,h.y,h.w,h.h,6); ctx.fill();
      ctx.fillStyle='rgba(31,42,68,.15)'; ctx.fillRect(h.x+6,h.y+6,h.w-12,6);
    }
  });

  ctx.fillStyle='#1f2a44'; ctx.font='18px system-ui';
  ctx.fillText(`Score: ${score}`,20,34);
  ctx.fillText(`Hearts: ${'♥'.repeat(hearts)}`,20,60);
  ctx.fillText(`Corridor Pace: ${(speed).toFixed(1)}x`,20,86);

  const need=60, w=220, p=corridorCoins/need;
  ctx.strokeStyle='rgba(31,42,68,.2)'; ctx.strokeRect(20,96,w,10);
  ctx.fillStyle='#86e3ce'; ctx.fillRect(20,96,w*p,10);
}

/* Loop / lifecycle */
let last=0;
function loop(ts){
  if(!running||paused){ last=ts; requestAnimationFrame(loop); return; }
  const dt=Math.min(0.033,(ts-last)/1000||0.016);
  last=ts; tick(dt); draw(); requestAnimationFrame(loop);
}
function startGame(){
  $('#titleScreen').style.display='none';
  $('#gameOverPanel').style.display='none';
  running=true; paused=false; slow=false; resetRun(); last=performance.now(); requestAnimationFrame(loop);
}
function gameOver(){
  running=false;
  $('#finalScoreText').textContent='Score: '+score;
  LB.add(score);
  $('#gameOverPanel').style.display='flex';
}

/* Controls */
const keys={};
addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='ArrowRight') vx=4;
  if(e.code==='ArrowLeft') vx=-3;
  if(e.code==='Space'){ if(onGround){ vy=-16; onGround=false; } else if(vy>-2){ vy=-14; } }
  if(e.code==='KeyS'){ vy=8; }
  if(e.code==='KeyD'){ x+=40; }
  if(e.code==='KeyP'){ paused=!paused; }
  if(e.code==='KeyL'){ slow=!slow; }
});
addEventListener('keyup',e=>{
  keys[e.code]=false;
  if(!keys['ArrowRight'] && !keys['ArrowLeft']) vx=0;
});

/* Mobile buttons */
const bind=(id,down,up)=>{ const el=$(id); if(!el) return;
  const press=(e)=>{e.preventDefault();down();};
  const release=(e)=>{e.preventDefault();up&&up();};
  el.addEventListener('touchstart',press); el.addEventListener('touchend',release);
  el.addEventListener('mousedown',press); el.addEventListener('mouseup',release);
};
bind('#btnLeft', ()=>{vx=-3;}, ()=>{ if(!keys['ArrowRight']) vx=0; });
bind('#btnRight',()=>{vx= 4;}, ()=>{ if(!keys['ArrowLeft']) vx=0; });
bind('#btnJump', ()=>{ if(onGround){vy=-16; onGround=false;} else if(vy>-2){vy=-14;} });
bind('#btnSlide',()=>{ vy=8; });
bind('#btnDash', ()=>{ x+=40; });

/* UI wires */
$('#btnStart').onclick=()=>{ LB.saveName(); startGame(); };
$('#btnShowLeaderboard').onclick=()=>{ LB.render(); $('#leaderboardPanel').style.display='flex'; };
$('#btnCloseLB').onclick=()=>{ $('#leaderboardPanel').style.display='none'; };
$('#btnExportCSV').onclick=()=>LB.exportCSV();
$('#btnRestart').onclick=()=>startGame();
$('#btnGoTitle').onclick=()=>{ $('#gameOverPanel').style.display='none'; $('#titleScreen').style.display='flex'; };

document.addEventListener('DOMContentLoaded',()=>{
  const n=localStorage.getItem(LS_NAME); if(n) $('#playerName').value=n;
});

/* Start in title */
$('#titleScreen').style.display='flex';
draw();
</script>
</body>
</html>
