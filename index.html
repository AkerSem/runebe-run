<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RUN EBE RUN — Doğumhaneye Ulaş!</title>
<style>
  :root{ --ink:#1f2a44; --stroke:rgba(31,42,68,.10); --shadow:0 10px 30px rgba(31,42,68,.18);}
  html,body{margin:0;height:100%;background:#eef2fb;color:var(--ink);font-family:ui-rounded,system-ui,"Segoe UI",Arial,sans-serif}
  #gameWrap{position:relative;width:100%;height:100vh;overflow:hidden}
  canvas{display:block;margin:0 auto;border-radius:18px;box-shadow:var(--shadow);
    background:radial-gradient(1200px 520px at 50% 30%, #ffffff 0%, #eef2fb 70%, #e3ecfa 100%)}
  /* tek panel */
  #panel{position:absolute;inset:0;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;
    text-align:center;padding:20px;background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,.25));backdrop-filter:blur(8px)}
  input,button{padding:12px 16px;border:1px solid var(--stroke);border-radius:14px;background:#fff;font-weight:600}
  button{cursor:pointer;transition:.2s transform,.2s box-shadow} button:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
  table{background:#fff;border-radius:14px;overflow:hidden;box-shadow:var(--shadow)} td,th{padding:8px 12px;border-bottom:1px solid var(--stroke)} th{background:#f7f9ff}
  /* mobil pad */
  #pad{position:absolute;left:0;right:0;bottom:14px;display:none;gap:10px;justify-content:center}
  .p{padding:14px 16px;border-radius:16px;background:#fff;border:1px solid var(--stroke)}
  @media (pointer:coarse){#pad{display:flex}}
</style>
</head>
<body>
<div id="gameWrap">
  <canvas id="game" width="1280" height="720"></canvas>

  <!-- TEK PANEL -->
  <div id="panel">
    <div id="titleArea">
      <h1>RUN EBE RUN</h1>
      <h3>Doğumhaneye Ulaş!</h3>
      <p style="max-width:720px">
        Parlak <b>hastane koridorlarında</b> koş, <b>doğum malzemelerini</b> topla, engellerden kaç.
        <br><b>Kaygan Döküntü</b>, <b>Panik Bulutu</b> ve <b>Evrak Yığını</b> seni yavaşlatabilir!
      </p>
      <label for="ad">Oyuncu Adı</label>
      <input id="ad" maxlength="12" placeholder="Runebe"/>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        <button id="basla">Başla</button>
        <button id="muzik">Müzik: Aç/Kapa (M)</button>
        <button id="lider">Liderlik Tablosu</button>
        <button id="yardim">Nasıl Oynanır?</button>
      </div>
      <small>← → hareket · Space zıpla (×2) · S kay · D kısa atıl · P duraklat · M müzik</small>
    </div>

    <div id="howto" style="display:none;max-width:760px;text-align:left">
      <h3>Nasıl Oynanır?</h3>
      <ul>
        <li>Malzemeler: Doğum Seti (+30), Şırınga (+18), Kordon Makası (+20), Bebek Bezi (+12), Önlük (+14), Eldiven (+10), Maske (+12)</li>
        <li>Engeller: Kaygan Döküntü, Panik Bulutu, Evrak Yığını</li>
        <li>Her 60 malzeme hız artar. 3 canın var. İyi şanslar!</li>
      </ul>
      <button id="kapatHow">Kapat</button>
    </div>

    <div id="lbArea" style="display:none">
      <h2>Liderlik Tablosu (İlk 10)</h2>
      <table id="lbTable"><thead><tr><th>#</th><th>Ad</th><th>Puan</th><th>Tarih</th></tr></thead><tbody></tbody></table>
      <button id="kapatLB">Kapat</button>
    </div>

    <div id="overArea" style="display:none">
      <h2>Oyun Bitti</h2>
      <p id="sonPuan">Puan: 0</p>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="yeniden">Yeniden</button>
        <button id="baslangic">Başlangıç</button>
      </div>
    </div>
  </div>

  <!-- mobil pad -->
  <div id="pad">
    <button class="p" id="sol">◀</button>
    <button class="p" id="sag">▶</button>
    <button class="p" id="zip">⤒</button>
    <button class="p" id="kay">—</button>
    <button class="p" id="dash">⚡</button>
  </div>
</div>

<script>
/* ========= kısayollar ========= */
const $=s=>document.querySelector(s);
const W=1280,H=720;
const LS_NAME='rer_tr_name', LS_LB='rer_tr_lb';
const canvas=$('#game'), ctx=canvas.getContext('2d');

/* ========= MÜZİK (WebAudio – hafif loop) ========= */
const Muzik=(()=>{
  let ctxA, master, beatG, melG, started=false, muted=false, timer;
  function init(){ if(ctxA) return;
    ctxA=new (window.AudioContext||window.webkitAudioContext)();
    master=ctxA.createGain(); master.gain.value=0.16; master.connect(ctxA.destination);
    beatG=ctxA.createGain(); beatG.gain.value=0.35; beatG.connect(master);
    melG =ctxA.createGain(); melG .gain.value=0.22; melG .connect(master);
  }
  function kick(t){ const o=ctxA.createOscillator(), g=ctxA.createGain();
    o.type='sine'; o.frequency.setValueAtTime(150,t);
    o.frequency.exponentialRampToValueAtTime(55,t+0.18);
    g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2);
    o.connect(g); g.connect(beatG); o.start(t); o.stop(t+0.21);}
  function hat(t){ const b=ctxA.createBuffer(1,2205,44100), d=b.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*((b.length-i)/b.length);
    const s=ctxA.createBufferSource(); s.buffer=b; const g=ctxA.createGain(); g.gain.value=0.18;
    s.connect(g); g.connect(beatG); s.start(t); }
  function note(freq,t,len=0.28){ const o=ctxA.createOscillator(); o.type='triangle';
    const g=ctxA.createGain(); g.gain.value=0.0001; g.gain.linearRampToValueAtTime(0.28,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.001,t+len); o.frequency.value=freq; o.connect(g); g.connect(melG);
    o.start(t); o.stop(t+len+0.05); }
  function start(){ init(); if(started) return; started=true;
    const tempo=112, spb=60/tempo; let step=0;
    function tick(){ const now=ctxA.currentTime;
      for(let tt=now; tt<now+0.3; tt+=spb){ const s=step++; if(s%2===0) kick(tt); hat(tt+spb*0.5);
        const scale=[261.63,293.66,329.63,392.00,523.25]; note(scale[(s>>2)%scale.length], tt+0.01, 0.24);}
      timer=setTimeout(tick,100);} tick(); }
  function stop(){ started=false; clearTimeout(timer); }
  function toggleMute(){ muted=!muted; if(master) master.gain.value = muted?0:0.16; }
  return {start,stop,toggleMute};
})();

/* ========= Liderlik ========= */
const LB=(()=>{
  const load=()=>JSON.parse(localStorage.getItem(LS_LB)||'[]');
  const save=a=>localStorage.setItem(LS_LB,JSON.stringify(a));
  const add=puan=>{ const ad=($('#ad').value||'Runebe').trim().slice(0,12);
    localStorage.setItem(LS_NAME,ad);
    const arr=load(); arr.push({ad,puan,at:new Date().toISOString()});
    arr.sort((a,b)=>b.puan-a.puan || a.at.localeCompare(b.at)); save(arr.slice(0,10)); render(); };
  const render=()=>{ const tb=$('#lbTable tbody'); tb.innerHTML='';
    load().forEach((r,i)=>{ const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${r.ad}</td><td>${r.puan}</td><td>${new Date(r.at).toLocaleDateString()}</td>`;
      tb.appendChild(tr); }); };
  return {add,render};
})();

/* ========= Oyun Durumu ========= */
let calisiyor=false, durak=false, t=0, last=0;
let hiz=6, vx=0, x=120, y=H-120, vy=0, yerde=true;
let can=3, puan=0, combo=0, ilerleme=0, zorluk=0;
let malzemeler=[], engeller=[], efekts=[];

/* ==== malzeme listesi ==== */
const MALZ=[
  {tur:'Doğum Seti',   puan:30, c:'#ffda55'},
  {tur:'Şırınga',      puan:18, c:'#86e3ce'},
  {tur:'Kordon Makası',puan:20, c:'#d4b5ff'},
  {tur:'Bebek Bezi',   puan:12, c:'#ffb3c1'},
  {tur:'Önlük',        puan:14, c:'#a8d8ff'},
  {tur:'Eldiven',      puan:10, c:'#7ed4c6'},
  {tur:'Maske',        puan:12, c:'#9ac7ff'}
];

/* ========= Çizim Yardımcıları ========= */
function rr(x,y,w,h,r){const q=Math.min(r,w/2,h/2);ctx.beginPath();
  ctx.moveTo(x+q,y);ctx.arcTo(x+w,y,x+w,y+h,q);ctx.arcTo(x+w,y+h,x,y+h,q);
  ctx.arcTo(x,y+h,x,y,q);ctx.arcTo(x,y,x+w,y,q);ctx.closePath();}
function cizKoridor(){
  const mid=H*0.58, vanX=W/2, vanY=mid-90;
  const gTop=ctx.createLinearGradient(0,0,0,mid); gTop.addColorStop(0,'#fefefe'); gTop.addColorStop(1,'#f2f6ff');
  ctx.fillStyle=gTop; ctx.fillRect(0,0,W,mid);
  const gFl=ctx.createLinearGradient(0,mid,0,H); gFl.addColorStop(0,'#dde4f7'); gFl.addColorStop(1,'#c9d4f1');
  ctx.fillStyle=gFl; ctx.fillRect(0,mid,W,H-mid);
  ctx.strokeStyle='rgba(31,42,68,.25)'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(vanX-120,vanY); ctx.lineTo(0,H); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(vanX+120,vanY); ctx.lineTo(W,H); ctx.stroke();
  ctx.strokeStyle='rgba(31,42,68,.15)'; ctx.lineWidth=2;
  for(let y=mid+18,st=20;y<H;y+=st,st*=1.08){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();}
  ctx.strokeStyle='rgba(255,255,255,.7)'; ctx.lineWidth=4;
  for(let i=0;i<6;i++){ const ofs=(i*200 + (t*220)%200); const y=H-(40+ofs);
    ctx.beginPath(); ctx.moveTo(W*0.25,y); ctx.lineTo(W*0.75,y); ctx.stroke();}
  const doorW=60,doorH=110; ctx.fillStyle='#fff';
  for(let i=0;i<3;i++){ const o=(i*320+(t*140)%320), yy=mid-35;
    let xR=W-40-o; if(xR>-doorW&&xR<W){ rr(xR,yy,doorW,doorH,10); ctx.fill();
      ctx.fillStyle='rgba(31,42,68,.06)'; ctx.fillRect(xR+doorW-10,yy+50,4,16); ctx.fillStyle='#fff';}
    let xL=40+o; if(xL>-doorW&&xL<W){ rr(xL,yy,doorW,doorH,10); ctx.fill();
      ctx.fillStyle='rgba(31,42,68,.06)'; ctx.fillRect(xL+6,yy+50,4,16); ctx.fillStyle='#fff';}}
  for(let i=0;i<5;i++){ const lx=((i*260+(t*70)%260)%(W+160))-80, ly=mid-130;
    ctx.fillStyle='rgba(255,255,255,.9)'; rr(lx,ly,66,14,7); ctx.fill();
    const glow=ctx.createRadialGradient(lx+33,ly+7,5,lx+33,ly+7,95);
    glow.addColorStop(0,'rgba(255,255,255,.35)'); glow.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(lx+33,ly+7,95,0,Math.PI*2); ctx.fill(); }
}
function cizAltinHalo(x,y,r){ const rg=ctx.createRadialGradient(x,y,r*0.2,x,y,r);
  rg.addColorStop(0,'rgba(255,255,255,.35)'); rg.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=rg; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
function cizMalzeme(m){
  ctx.save(); ctx.translate(m.x,m.y); ctx.lineWidth=3;
  if(m.tur==='Doğum Seti'){ ctx.fillStyle:m.col; rr(-16,-12,32,24,6); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.8)'; rr(-10,-4,20,8,3); ctx.fill(); }
  else if(m.tur==='Şırınga'){ ctx.strokeStyle=m.c; ctx.lineWidth=2.5;
    rr(-10,-6,20,12,3); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-12,0); ctx.lineTo(-18,0); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(10,0); ctx.lineTo(20,0); ctx.stroke();}
  else if(m.tur==='Kordon Makası'){ ctx.strokeStyle=m.c; ctx.lineWidth=3;
    ctx.beginPath(); ctx.arc(-6,0,6,0,Math.PI*2); ctx.arc(8,0,6,0,Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-2,0); ctx.lineTo(14,-10); ctx.stroke(); }
  else if(m.tur==='Bebek Bezi'){ ctx.fillStyle=m.c; rr(-14,-10,28,20,8); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.7)'; rr(-10,-6,20,12,6); ctx.fill(); }
  else if(m.tur==='Önlük'){ ctx.fillStyle=m.c; rr(-12,-6,24,20,6); ctx.fill();
    ctx.fillStyle='#fff'; rr(-6,-2,12,8,3); ctx.fill();}
  else if(m.tur==='Eldiven'){ ctx.fillStyle=m.c; rr(-12,-10,24,20,8); ctx.fill(); ctx.fillRect(2,-14,6,10); }
  else if(m.tur==='Maske'){ ctx.fillStyle=m.c; rr(-14,-6,28,12,6); ctx.fill();
    ctx.strokeStyle=m.c; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-14,-2); ctx.lineTo(-20,-4); ctx.moveTo(-14,2); ctx.lineTo(-20,4);
    ctx.moveTo(14,-2);  ctx.lineTo(20,-4); ctx.moveTo(14,2);  ctx.lineTo(20,4); ctx.stroke(); }
  ctx.globalAlpha=.35; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.ellipse(-8,-10,14,6,-0.5,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=1; ctx.restore();
}
function cizKarakter(){ // saç animasyonlu
  ctx.fillStyle='#ffc9de'; rr(x,y,40,40,10); ctx.fill();
  const hx=x+20, hy=y-8;
  ctx.fillStyle='#ffd9e6'; ctx.beginPath(); ctx.arc(hx,hy,14,0,Math.PI*2); ctx.fill();
  const sal=Math.sin(t*8 + x*0.01)*4 + (vx>0?1:0);
  ctx.fillStyle='#4a3b3f'; ctx.beginPath(); ctx.ellipse(hx-10-sal,hy+2,12,8,-0.3,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#2b2b2b'; ctx.beginPath(); ctx.arc(hx+4,hy-2,1.8,0,Math.PI*2); ctx.fill();
}

/* ========= Spawn ========= */
function spawnMalz(){ const lanes=[0,60,120], m=MALZ[Math.floor(Math.random()*MALZ.length)];
  malzemeler.push({tur:m.tur, puan:m.puan, c:m.c, x:W+40, y:H-120-lanes[Math.floor(Math.random()*lanes.length)]}); }
function spawnEngel(){ const baseY=H-100, r=Math.random();
  if(r<0.4) engeller.push({tip:'spill',x:W+60,y:baseY,w:60,h:26});
  else if(r<0.7){ const yy=baseY-60-Math.random()*100; engeller.push({tip:'panic',x:W+60,y:yy,vy:(Math.random()<.5?0.4:-0.4)}); }
  else engeller.push({tip:'paper',x:W+60,y:baseY-40,w:40,h:40}); }

/* ========= Döngü ========= */
function reset(){ hiz=6; vx=0; x=120; y=H-120; vy=0; yerde=true;
  can=3; puan=0; combo=0; ilerleme=0; zorluk=0; malzemeler=[]; engeller=[]; efekts=[]; }
function tick(dt){
  zorluk += dt*0.06; hiz = 6 + zorluk*1.2 + Math.min(2, Math.floor(puan/200)*0.5); t += dt;
  if (t%1 < dt){ const mc=0.65+Math.min(.2,zorluk*0.15), ec=0.2+Math.min(.45,zorluk*0.25);
    if(Math.random()<mc) spawnMalz(); if(Math.random()<ec) spawnEngel(); }
  x += vx; vy += 0.9; y += vy; if(y>H-120){ y=H-120; vy=0; yerde=true; }
  malzemeler.forEach(c=>c.x-=hiz); engeller.forEach(h=>{ h.x-=hiz; if(h.tip==='panic'){ h.y+=h.vy; if(h.y<H-220||h.y>H-80) h.vy*=-1; }});
  efekts=efekts.filter(e=> (e.t+=dt) < 1);
  // toplama
  malzemeler = malzemeler.filter(c=>{ const hit=Math.hypot((x+20)-c.x,(y+20)-c.y) < 26;
    if(hit){ puan += c.puan*(1+Math.floor(combo/5)); combo++; ilerleme++; efekts.push({x:c.x,y:c.y,txt:`+${c.puan} ${c.tur}`,t:0}); }
    return !hit && c.x>-40; });
  // engel
  engeller = engeller.filter(h=>{ let hit=false;
    if(h.tip==='panic') hit=Math.hypot((x+20)-h.x,(y+20)-h.y)<30;
    else hit=(x+20>h.x && x<h.x+(h.w||0) && y+40>h.y && y<h.y+(h.h||0));
    if(hit){ can--; combo=0; } return !hit && h.x>-60; });
  if(ilerleme>=60){ ilerleme=0; hiz+=0.6; }
  if(can<=0) gameOver();
}
function draw(){
  cizKoridor();
  malzemeler.forEach(c=>{ cizMalzeme({x:c.x,y:c.y,tur:c.tur,c:c.c}); cizAltinHalo(c.x,c.y,18); });
  engeller.forEach(h=>{
    if(h.tip==='spill'){ ctx.fillStyle='#a8d8ff'; rr(h.x,h.y,h.w,h.h,8); ctx.fill();
      ctx.globalAlpha=.25; ctx.fillStyle='#fff'; rr(h.x+6,h.y+5,h.w-12,h.h-10,8); ctx.fill(); ctx.globalAlpha=1; }
    else if(h.tip==='panic'){ ctx.globalAlpha=.75; ctx.fillStyle='#ffd3b6'; ctx.beginPath(); ctx.arc(h.x,h.y,22,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
    else { ctx.fillStyle='#d4b5ff'; rr(h.x,h.y,h.w,h.h,6); ctx.fill(); ctx.fillStyle='rgba(31,42,68,.15)'; ctx.fillRect(h.x+6,h.y+6,h.w-12,6); }
  });
  cizKarakter();
  ctx.font='16px system-ui'; ctx.textAlign='left';
  efekts.forEach(e=>{ ctx.globalAlpha=1-e.t; ctx.fillStyle='#1f2a44'; ctx.fillText(e.txt,e.x+12,e.y-8-e.t*20); ctx.globalAlpha=1; });
  ctx.fillStyle='#1f2a44'; ctx.textAlign='left'; ctx.font='18px system-ui';
  ctx.fillText(`Puan: ${puan}`,20,34); ctx.fillText(`Can: ${'♥'.repeat(can)}`,20,60); ctx.fillText(`Koridor Hızı: ${hiz.toFixed(1)}x`,20,86);
  const w=220,p=ilerleme/60; ctx.strokeStyle='rgba(31,42,68,.2)'; ctx.strokeRect(20,96,w,10); ctx.fillStyle='#86e3ce'; ctx.fillRect(20,96,w*p,10);
}
function loop(ts){ if(!calisiyor||durak){ last=ts; requestAnimationFrame(loop); return; }
  const dt=Math.min(0.033,(ts-last)/1000||0.016); last=ts; tick(dt); draw(); requestAnimationFrame(loop); }

/* ========= Yaşam Döngüsü & UI ========= */
function start(){ $('#panel').style.display='none'; calisiyor=true; durak=false; reset();
  if(Muzik) Muzik.start(); last=performance.now(); requestAnimationFrame(loop); }
function gameOver(){ calisiyor=false; if(Muzik) Muzik.stop();
  $('#sonPuan').textContent='Puan: '+puan; LB.add(puan);
  $('#titleArea').style.display='none'; $('#howto').style.display='none'; $('#lbArea').style.display='none';
  $('#overArea').style.display='block'; $('#panel').style.display='flex'; }

const tus={};
addEventListener('keydown',e=>{
  tus[e.code]=true;
  if(e.code==='ArrowRight') vx=4;
  if(e.code==='ArrowLeft')  vx=-3;
  if(e.code==='Space'){ if(yerde){ vy=-16;yerde=false;} else if(vy>-2){ vy=-14;} }
  if(e.code==='KeyS'){ vy=8; }
  if(e.code==='KeyD'){ x+=40; }
  if(e.code==='KeyP'){ durak=!durak; }
  if(e.code==='KeyM'){ if(Muzik) Muzik.toggleMute(); }
});
addEventListener('keyup',e=>{ tus[e.code]=false; if(!tus['ArrowRight'] && !tus['ArrowLeft']) vx=0; });

function bind(id,down,up){ const el=$(id); if(!el) return;
  const press=e=>{e.preventDefault();down();}, rel=e=>{e.preventDefault();up&&up();};
  el.addEventListener('touchstart',press); el.addEventListener('touchend',rel);
  el.addEventListener('mousedown',press); el.addEventListener('mouseup',rel);
}
bind('#sol', ()=>{vx=-3;}, ()=>{ if(!tus['ArrowRight']) vx=0; });
bind('#sag', ()=>{vx= 4;}, ()=>{ if(!tus['ArrowLeft'])  vx=0; });
bind('#zip', ()=>{ if(yerde){vy=-16;yerde=false;} else if(vy>-2){vy=-14;} });
bind('#kay', ()=>{ vy=8; });
bind('#dash',()=>{ x+=40; });

document.addEventListener('DOMContentLoaded',()=>{
  const n=localStorage.getItem(LS_NAME); if(n) $('#ad').value=n;
  $('#basla').onclick=()=>start();
  $('#muzik').onclick=()=>{ if(Muzik) Muzik.toggleMute(); };
  $('#lider').onclick=()=>{ LB.render(); $('#titleArea').style.display='none'; $('#lbArea').style.display='block'; };
  $('#kapatLB').onclick=()=>{ $('#lbArea').style.display='none'; $('#titleArea').style.display='block'; };
  $('#yardim').onclick=()=>{ $('#titleArea').style.display='none'; $('#howto').style.display='block'; };
  $('#kapatHow').onclick=()=>{ $('#howto').style.display='none'; $('#titleArea').style.display='block'; };
  $('#yeniden').onclick=()=>start();
  $('#baslangic').onclick=()=>{ $('#overArea').style.display='none'; $('#lbArea').style.display='none'; $('#howto').style.display='none'; $('#titleArea').style.display='block'; };
  // ilk çizim
  draw();
});
</script>
</body>
</html>
